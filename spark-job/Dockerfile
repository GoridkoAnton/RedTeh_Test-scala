# Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð· Java 8 (Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐ¾ Spark 3.1.x)
FROM openjdk:8-jdk

# ÐœÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ
LABEL maintainer="RedTeh DevOps" \
      description="Spark Compact Job with Gist Loader"

# ------------------------------------------------------------------------------
# 1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹: curl, bash, scala
# ------------------------------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        bash \
        scala \
        unzip \
        procps && \
    rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------------------------
# 2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Apache Spark
# ------------------------------------------------------------------------------
ENV SPARK_VERSION=3.1.3 \
    HADOOP_VERSION=3.2 \
    SPARK_HOME=/opt/spark \
    PATH=$PATH:/opt/spark/bin

RUN curl -fsSL https://downloads.apache.org/spark/spark-${SPARK_VERSION}/spark-${SPARK_VERSION}-bin-hadoop${HADOOP_VERSION}.tgz -o /tmp/spark.tgz && \
    mkdir -p /opt && \
    tar -xzf /tmp/spark.tgz -C /opt && \
    mv /opt/spark-${SPARK_VERSION}-bin-hadoop${HADOOP_VERSION} /opt/spark && \
    rm /tmp/spark.tgz

# ------------------------------------------------------------------------------
# 3. Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ PostgreSQL JDBC-Ð´Ñ€Ð°Ð¹Ð²ÐµÑ€Ð°
# ------------------------------------------------------------------------------
RUN curl -fsSL https://jdbc.postgresql.org/download/postgresql-42.7.3.jar -o /opt/postgresql-jdbc.jar

# ------------------------------------------------------------------------------
# 4. ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¸ÐºÐ¸ Ð¸ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Scala-Ð¿Ñ€Ð¾ÐµÐºÑ‚
# ------------------------------------------------------------------------------
WORKDIR /opt/job

COPY ./spark-job /opt/job

RUN ./sbt clean assembly

# ------------------------------------------------------------------------------
# 5. ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°
# ------------------------------------------------------------------------------
RUN bash -c 'cat > /opt/job/run << "EOF" \
#!/usr/bin/env bash
set -euo pipefail

DATA_DIR=${DATA_DIR:-/data/parquet}
TARGET_FILE_MB=${TARGET_FILE_MB:-64}
GIST_URL=${GIST_URL:-}

echo "ðŸš€ Starting SparkCompactJob"
echo "DATA_DIR=$DATA_DIR"
echo "TARGET_FILE_MB=$TARGET_FILE_MB"
echo "GIST_URL=$GIST_URL"

$SPARK_HOME/bin/spark-submit \
  --class com.example.SparkCompactJob \
  --master local[*] \
  --driver-class-path /opt/postgresql-jdbc.jar \
  --jars /opt/postgresql-jdbc.jar \
  /opt/job/target/scala-2.12/spark-compact-job-assembly.jar \
  --data-dir=$DATA_DIR \
  --target-file-mb=$TARGET_FILE_MB
EOF' && chmod +x /opt/job/run

# ------------------------------------------------------------------------------
# 6. Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ Ñ‚Ð¾Ñ‡ÐºÑƒ Ð²Ñ…Ð¾Ð´Ð°
# ------------------------------------------------------------------------------
WORKDIR /opt/job
ENTRYPOINT ["/opt/job/run"]
